<view class="container">
  <!-- è°ƒè¯•ä¿¡æ¯ -->
  <view class="debug-info" wx:if="{{currentEnv === 'development' || currentEnv === 'trial'}}">
    <view class="debug-text">å½“å‰ç¯å¢ƒ: {{currentEnv}}</view>
    <view class="debug-text">æ¨¡æ‹Ÿæ¨¡å¼: {{isMockMode ? 'æ˜¯' : 'å¦'}}</view>
    <view class="debug-text">ä¼šè¯æ•°é‡: {{conversations.length}}</view>
  </view>

  <!-- æƒé™æç¤ºï¼šå·²ç™»å½•ä½†æ— æƒé™ -->
  <view class="login-tip" wx:if="{{!isMockMode && currentEnv === 'release' && isLoggedIn && (userInfo.status !== 1 || (userInfo.role && userInfo.role === 'banned'))}}">
    <view class="tip-text">å½“å‰è´¦å·æ— æƒé™æŸ¥çœ‹å†å²è®°å½•ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å¼€é€š</view>
    <button class="login-btn" bindtap="goToChat">å»å¯¹è¯</button>
  </view>

  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <view class="page-title">å¯¹è¯å†å²</view>
    <view class="header-actions">
      <button class="action-btn" bindtap="refreshHistory">åˆ·æ–°</button>
      <button class="action-btn danger" bindtap="clearHistory">æ¸…ç©º</button>
    </view>
  </view>

  <!-- ä¼šè¯åˆ—è¡¨ -->
  <view class="conversations-section" wx:if="{{conversations.length > 0}}">
    <view class="section-title">ä¼šè¯åˆ—è¡¨</view>
    <view class="conversation-list">
      <view 
        wx:for="{{conversations}}" 
        wx:key="conversation_id"
        class="conversation-item"
        bindtap="viewConversation"
        data-conversation="{{item}}"
      >
        <view class="conversation-content">
          <view class="conversation-preview">
            <view class="preview-text">{{item.last_user_message}}</view>
            <view class="preview-reply">{{item.last_bot_reply}}</view>
          </view>
          <view class="conversation-meta">
            <view class="message-count">{{item.message_count}}æ¡æ¶ˆæ¯</view>
            <view class="last-time">{{item.last_message_time}}</view>
          </view>
        </view>
        <view class="conversation-arrow">></view>
      </view>
    </view>
  </view>

  <!-- å¯¹è¯è®°å½•åˆ—è¡¨ -->
  <view class="history-section" wx:if="{{currentConversation}}">
    <view class="section-header">
      <view class="back-btn" bindtap="backToConversations">â† è¿”å›ä¼šè¯</view>
      <view class="conversation-title">ä¼šè¯è¯¦æƒ…</view>
      <view class="clear-btn" bindtap="clearCurrentConversation">æ¸…ç©º</view>
    </view>
    
    <view class="message-list">
      <view 
        wx:for="{{messages}}" 
        wx:key="id"
        class="message-item {{item.user_message ? 'message-user' : 'message-bot'}}"
      >
        <view class="message-avatar">
          {{item.user_message ? 'ğŸ‘¤' : 'ğŸ¤–'}}
        </view>
        <view class="message-content">
          <view class="message-text">
            {{item.user_message || item.bot_reply}}
          </view>
          <view class="message-meta">
            <view class="message-time">{{item.created_at}}</view>
            <view class="message-actions" wx:if="{{!item.user_message}}">
              <button 
                class="action-btn small"
                bindtap="copyMessage"
                data-content="{{item.bot_reply}}"
              >
                å¤åˆ¶
              </button>
              <button 
                class="action-btn small {{item.liked ? 'liked' : ''}}"
                bindtap="toggleLike"
                data-id="{{item.id}}"
              >
                {{item.liked ? 'å·²èµ' : 'ç‚¹èµ'}}
              </button>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- åˆ†é¡µ -->
    <view class="pagination" wx:if="{{pagination.pages > 1}}">
      <button 
        class="page-btn {{pagination.page <= 1 ? 'disabled' : ''}}"
        bindtap="prevPage"
        disabled="{{pagination.page <= 1}}"
      >
        ä¸Šä¸€é¡µ
      </button>
      <view class="page-info">
        {{pagination.page}} / {{pagination.pages}}
      </view>
      <button 
        class="page-btn {{pagination.page >= pagination.pages ? 'disabled' : ''}}"
        bindtap="nextPage"
        disabled="{{pagination.page >= pagination.pages}}"
      >
        ä¸‹ä¸€é¡µ
      </button>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!currentConversation && conversations.length === 0}}">
    <view class="empty-icon">ğŸ“š</view>
    <view class="empty-text">æš‚æ— å¯¹è¯å†å²</view>
    <view class="empty-desc">å¼€å§‹å¯¹è¯åï¼Œæ‚¨çš„å¯¹è¯è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</view>
    <button class="primary-btn" bindtap="goToChat">å¼€å§‹å¯¹è¯</button>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{isLoading}}">
    <view class="loading-spinner"></view>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>
</view>





